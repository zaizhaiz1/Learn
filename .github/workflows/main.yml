name: Public_Secure_Persistent_RDP
on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360 

    steps:
    - name: 1. Setup Tailscale
      uses: tailscale/github-action@v4
      with:
        authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
        hostname: BSIT-Cloud-PC

    - name: 2. Setup RDP & Sync All Apps
      continue-on-error: true 
      run: |
        # A. Setup RDP User
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        $Password = ConvertTo-SecureString "${{ secrets.RDP_PASSWORD }}" -AsPlainText -Force
        New-LocalUser "CloudUser" -Password $Password -Description "RDP User"
        Add-LocalGroupMember -Group "Administrators" -Member "CloudUser"
        
        # B. Install Rclone
        Invoke-WebRequest https://downloads.rclone.org/rclone-current-windows-amd64.zip -OutFile rclone.zip
        Expand-Archive rclone.zip -DestinationPath C:\rclone
        New-Item -ItemType Directory -Path "C:\rclone\config" -Force
        @"
        ${{ secrets.RCLONE_CONFIG_DATA }}
        "@ | Out-File -FilePath "C:\rclone\config\rclone.conf" -Encoding utf8
        
        $RcloneExe = Get-ChildItem -Path "C:\rclone" -Filter "rclone.exe" -Recurse | Select-Object -ExpandProperty FullName
        
        # C. THE TRICK: Sync the entire 'MyApps' folder
        & $RcloneExe sync MyDrive:MyApps "C:\Users\Public\Desktop\MyApps" --config C:\rclone\config\rclone.conf
        
        # D. Pull Saves (Only if they exist)
        $CloudUserAppData = "C:\Users\CloudUser\AppData\Roaming\RenPy"
        if (!(Test-Path $CloudUserAppData)) { New-Item -ItemType Directory -Path $CloudUserAppData -Force }
        & $RcloneExe copy "MyDrive:CrossRealms-Saves/AppData_RenPy" $CloudUserAppData --config C:\rclone\config\rclone.conf --ignore-errors

    - name: 3. Activity Simulation (RDP Session)
      run: |
        Write-Host "RDP Active. All your apps are in the 'MyApps' folder on the desktop."
        for ($i=0; $i -lt 360; $i++) {
          Write-Host "Session heartbeat... ($i min)"
          Start-Sleep -Seconds 60
        }

    - name: 4. AUTO-SAVE ALL PROGRESS (Always Runs)
      if: always()
      timeout-minutes: 10 
      run: |
        $RcloneExe = Get-ChildItem -Path "C:\rclone" -Filter "rclone.exe" -Recurse | Select-Object -ExpandProperty FullName
        
        # Sync the entire MyApps folder back to Drive
        & $RcloneExe sync "C:\Users\Public\Desktop\MyApps" MyDrive:MyApps --config C:\rclone\config\rclone.conf
        
        # Sync Saves
        $CloudUserAppData = "C:\Users\CloudUser\AppData\Roaming\RenPy"
        if (Test-Path $CloudUserAppData) {
          & $RcloneExe copy $CloudUserAppData "MyDrive:CrossRealms-Saves/AppData_RenPy" --config C:\rclone\config\rclone.conf --ignore-checksum --ignore-errors
        }
