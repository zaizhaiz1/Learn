name: Public_Secure_Persistent_RDP
on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    # No timeout-minutes needed for cost, but keep it at 360 for safety
    timeout-minutes: 360 

    steps:
    - name: 1. Restore SavedWork (Magic Suitcase)
      uses: actions/cache@v4
      with:
        path: C:\Users\RunnerAdmin\SavedWork
        key: rdp-v1-${{ github.run_id }}-${{ github.run_attempt }}
        restore-keys: |
          rdp-v1-

    - name: 2. Setup Tailscale
      uses: tailscale/github-action@v4
      with:
        authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
        hostname: BSIT-Cloud-PC

    - name: 3. Mask IP and Connection Info
      run: |
        # This command tells GitHub to hide the IP in the logs automatically
        $MyIP = (tailscale ip -4)
        echo "::add-mask::$MyIP"
        echo "IP_ADDRESS=$MyIP" >> $env:GITHUB_ENV

    - name: 4. Configure Windows & RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
        
        $Password = ConvertTo-SecureString "${{ secrets.RDP_PASSWORD }}" -AsPlainText -Force
        New-LocalUser "CloudUser" -Password $Password -Description "RDP User"
        Add-LocalGroupMember -Group "Administrators" -Member "CloudUser"
        
        if (!(Test-Path "C:\Users\RunnerAdmin\SavedWork")) { New-Item -ItemType Directory -Path "C:\Users\RunnerAdmin\SavedWork" }

    - name: 5. Display Connection Info (Masked)
      run: |
        Write-Host "--- CONNECTION INFO ---"
        # The IP will show as *** in the public logs, but you can see it in your Tailscale app
        Write-Host "IP Address: ${{ env.IP_ADDRESS }}"
        Write-Host "Username: CloudUser"
        Write-Host "-----------------------"

    - name: 6. Activity Simulation (Anti-Abuse)
      run: |
        Write-Host "Starting simulation to stay safe from anti-abuse..."
        $duration = 18010 # 5 hours 10 seconds
        $start = Get-Date
        while ((Get-Date) -lt $start.AddSeconds($duration)) {
            # This tiny task keeps the CPU active so GitHub doesn't think you're idle
            $active = Get-Process | Select-Object -First 5
            Start-Sleep -Seconds 300 
        }
