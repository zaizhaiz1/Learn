name: Public_Secure_Persistent_RDP
on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360 

    steps:
    - name: 1. Restore SavedWork (Magic Suitcase)
      uses: actions/cache@v4
      with:
        path: C:\Users\RunnerAdmin\SavedWork
        key: rdp-v1-${{ github.run_id }}-${{ github.run_attempt }}
        restore-keys: |
          rdp-v1-

    - name: 2. Setup Tailscale
      uses: tailscale/github-action@v4
      with:
        authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
        hostname: BSIT-Cloud-PC

    - name: 3. Configure Windows & RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
        
        $Password = ConvertTo-SecureString "${{ secrets.RDP_PASSWORD }}" -AsPlainText -Force
        New-LocalUser "CloudUser" -Password $Password -Description "RDP User"
        Add-LocalGroupMember -Group "Administrators" -Member "CloudUser"
        
        if (!(Test-Path "C:\Users\RunnerAdmin\SavedWork")) { New-Item -ItemType Directory -Path "C:\Users\RunnerAdmin\SavedWork" }

    - name: 4. Activity Simulation
      run: |
        Write-Host "RDP Active. Remember to put your files in C:\Users\RunnerAdmin\SavedWork"
        Start-Sleep -Seconds 18010

    # THIS IS THE NEW STEP THAT FIXES THE SAVE PROBLEM
    - name: 5. Force Save Cache
      if: always() # This makes it run even if you click "Cancel Run"
      uses: actions/cache/save@v4
      with:
        path: C:\Users\RunnerAdmin\SavedWork
        key: rdp-v1-${{ github.run_id }}-${{ github.run_attempt }}
