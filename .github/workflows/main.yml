name: Public_Secure_Persistent_RDP
on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360 

    steps:
    - name: 1. Setup Tailscale
      uses: tailscale/github-action@v4
      with:
        authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
        hostname: BSIT-Cloud-PC

    - name: 2. Install WinFsp, Rclone, and Mount Drive
      run: |
        # A. Install WinFsp (Required for mounting the Z: drive)
        Invoke-WebRequest https://github.com/winfsp/winfsp/releases/download/v2.0/winfsp-2.0.23075.msi -OutFile winfsp.msi
        Start-Process msiexec.exe -ArgumentList "/i winfsp.msi /quiet /norestart" -Wait
        
        # B. Standard RDP & User Setup
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        $Password = ConvertTo-SecureString "${{ secrets.RDP_PASSWORD }}" -AsPlainText -Force
        New-LocalUser "CloudUser" -Password $Password -Description "RDP User"
        Add-LocalGroupMember -Group "Administrators" -Member "CloudUser"
        
        # C. Install Rclone
        Invoke-WebRequest https://downloads.rclone.org/rclone-current-windows-amd64.zip -OutFile rclone.zip
        Expand-Archive rclone.zip -DestinationPath C:\rclone
        
        # D. Create Config File from Secret
        New-Item -ItemType Directory -Path "C:\rclone\config" -Force
        @"
        ${{ secrets.RCLONE_CONFIG_DATA }}
        "@ | Out-File -FilePath "C:\rclone\config\rclone.conf" -Encoding utf8
        
        # E. Mount Google Drive as Z: Drive (Auto-Find Fix)
        $RcloneExe = Get-ChildItem -Path "C:\rclone" -Filter "rclone.exe" -Recurse | Select-Object -ExpandProperty FullName
        Start-Process $RcloneExe -ArgumentList "mount MyDrive: Z: --config C:\rclone\config\rclone.conf --vfs-cache-mode full" -WindowStyle Hidden
        
        # F. Wait for mount and create Desktop Shortcut
        Start-Sleep -Seconds 20
        $DesktopPath = "C:\Users\Public\Desktop\CrossRealms.lnk"
        $WshShell = New-Object -ComObject WScript.Shell
        $Shortcut = $WshShell.CreateShortcut($DesktopPath)
        $Shortcut.TargetPath = "Z:\CrossRealms-0.4-pc\CrossRealms.exe"
        $Shortcut.WorkingDirectory = "Z:\CrossRealms-0.4-pc\"
        $Shortcut.Save()

    - name: 3. Activity Simulation
      run: |
        Write-Host "RDP Active. Google Drive (Z:) is now connected properly."
        Start-Sleep -Seconds 18010
